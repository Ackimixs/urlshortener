<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
<div id="container">
    <div>
        <h1>Url Shortener</h1>
        <div>
            <input type="text" name="long_url" id="long_url" placeholder="longUrl">
            <input type="text" name="code" id="code" placeholder="Code">
            <button id="submit">Submit</button>
        </div>
        <p id="result">Result : </p>

        <div id="listOfUrl">
            <h1>List of Url</h1>
            <table id="tableOfUrl">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>Long url</th>
                        <th>Code</th>
                        <th>Edit</th>
                        <th>Delete</th>
                        <th>Go</th>
                    </tr>    
                </thead>
                <tbody id="urlData">
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html, body {
        height: 100%;
    }

    #container {
        display: grid;
        height: 100%;
        place-items: center;
    }

    tr, td, th, table {
        border: 1px solid black;
    }

    td > * {
        width: 100%;
        border: none;
        padding: 5px;
    }

</style>
<script>

    document.querySelector("#submit").addEventListener("click", async () => {
        document.querySelector("#result").innerHTML = "Result : ";
        const long_url = document.querySelector("#long_url").value;
        const code = document.querySelector("#code").value;

        console.log(long_url, code);

        const url = await fetch("/api/url", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ long_url, code }),
        });

        const data = await url.json();

        console.log(data);

        document.querySelector("#result").innerHTML += window.location.origin + "/r/" + data.body.url.code;

        if (data?.body?.url) {
            addData(data.body.url);
        }
    });


    const refresh = async () => {
        const BodytableOfUrl = document.querySelector("#urlData");

        while (BodytableOfUrl.firstChild) {
            BodytableOfUrl.removeChild(BodytableOfUrl.firstChild);
        }

        const url = await fetch("/api/url", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        });

        const data = await url.json();

        if (!data?.body?.url) return;

        for (const urlData of data.body.url) {
            const tr = document.createElement("tr");
            tr.id = `id-${urlData.id}`;

            const tdId = document.createElement("td");
            const idP = document.createElement("p");
            tdId.appendChild(idP);

            const tdLongUrl = document.createElement("td");
            const longUrlInput = document.createElement("input");
            tdLongUrl.appendChild(longUrlInput);

            const tdCode = document.createElement("td");
            const codeInput = document.createElement("input");
            tdCode.appendChild(codeInput);

            const tdGo = document.createElement("td");

            const tdDelete = document.createElement("td");
            const deleteButton = document.createElement("button");
            deleteButton.innerHTML = "Delete";
            deleteButton.addEventListener("click", async (e) => {
                const url = await fetch(`/api/url/${urlData.id}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });

                const data = await url.json();

                console.log(data);

                if (data?.body?.url) {
                    document.querySelector(`#id-${urlData.id}`).remove();
                }
            });

            const tdEdit = document.createElement("td");
            const editButton = document.createElement("button");
            editButton.innerHTML = "Edit";
            editButton.addEventListener("click", async (e) => {
                const url = await fetch(`/api/url/${urlData.id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ code: codeInput.value, long_url: longUrlInput.value }),
                });

                const data = await url.json();

                console.log(data);

                if (data?.body?.url) {
                    editUrl(data.body.url);
                }
            });

            idP.innerHTML = urlData.id;
            longUrlInput.value = urlData.long_url;
            codeInput.value = urlData.code;
            tdEdit.appendChild(editButton);
            tdDelete.appendChild(deleteButton);

            tdGo.innerHTML = `<a href="${window.location.origin}/r/${urlData.code}" target="__blank">Go</a>`;

            tr.appendChild(tdId);
            tr.appendChild(tdLongUrl);
            tr.appendChild(tdCode);
            tr.appendChild(tdEdit);
            tr.appendChild(tdDelete);

            tr.appendChild(tdGo);


            BodytableOfUrl.appendChild(tr);
        }
    }

    const addData = (url) => {
        const BodytableOfUrl = document.querySelector("#urlData");

        const tr = document.createElement("tr");
        tr.id = `id-${url.id}`;
        
        const tdId = document.createElement("td");
        const idP = document.createElement("p");
        tdId.appendChild(idP);

        const tdLongUrl = document.createElement("td");
        const longUrlInput = document.createElement("input");
        tdLongUrl.appendChild(longUrlInput);

        const tdCode = document.createElement("td");
        const codeInput = document.createElement("input");
        tdCode.appendChild(codeInput);

        const tdGo = document.createElement("td");

        const tdDelete = document.createElement("td");
        const deleteButton = document.createElement("button");
        deleteButton.innerHTML = "Delete";
        deleteButton.addEventListener("click", async (e) => {
            const url = await fetch(`/api/url/${url.id}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                },
            });

            const data = await url.json();

            console.log(data);

            if (data?.body?.url) {
                document.querySelector(`#id-${url.id}`).remove();
            }
        });

        const tdEdit = document.createElement("td");
        const editButton = document.createElement("button");
        editButton.innerHTML = "Edit";

        editButton.addEventListener("click", async (e) => {
            const url = await fetch(`/api/url/${url.id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ code: codeInput.value, long_url: longUrlInput.value }),
            });

            const data = await url.json();

            console.log(data);

            if (data?.body?.url) {
                editUrl(data.body.url);
            }
        });

        idP.innerHTML = url.id;
        longUrlInput.value = url.long_url;
        codeInput.value = url.code;
        tdEdit.appendChild(editButton);
        tdDelete.appendChild(deleteButton);

        tdGo.innerHTML = `<a href="${window.location.origin}/r/${url.code}" target="__blank">Go</a>`;

        tr.appendChild(tdId);
        tr.appendChild(tdLongUrl);
        tr.appendChild(tdCode);
        tr.appendChild(tdEdit);
        tr.appendChild(tdDelete);

        tr.appendChild(tdGo);

        BodytableOfUrl.appendChild(tr);
    }

    const editUrl = (url) => {
        const tr = document.querySelector(`#id-${url.id}`);

        const idP = tr.querySelector("p");
        const longUrlInput = tr.querySelector("input");
        const codeInput = tr.querySelectorAll("input")[1];

        idP.innerHTML = url.id;
        longUrlInput.value = url.long_url;
        codeInput.value = url.code;
    }

    (async () => {
        await refresh();
    })()

</script>
</html>